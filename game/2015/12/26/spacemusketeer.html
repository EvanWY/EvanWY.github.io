<!DOCTYPE html>
<html lang="en">

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-72425463-1', 'auto');
  ga('send', 'pageview');

</script>

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Wang Yang - Portfolio</title>

    <!-- Bootstrap Core CSS -->
    <link href="/css/bootstrap.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/css/1-col-portfolio.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link href="/css/syntax.css" rel="stylesheet">

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Wang Yang's Portfolio&nbsp;&nbsp;&nbsp;&nbsp;</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="/">Projects</a>
                    </li>
                    <li>
                        <a href="/about/">About</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <div class="container">
	<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Space Musketeer <small>Jul 2015 to Present</small></h1>
        <img class="img-responsive" src="/img/spacemusketeer/cover.jpg" />
        <!--<p class="post-excerpt"> content  </p>-->
        <br>
        <b>My largest one-person game project</b>
        <p>It is a multiplayer online shooting game, with top-down perspective and twin stick control. I design and programming, and find most of the art resources from Unity Asset Store. I try my best to make this game simple but high-quality.</p>

<h3 id="overview">Overview</h3>

<ul>
  <li><strong>Role</strong>: Designer, Programmer, Artist</li>
  <li><strong>Platform</strong>: iOS</li>
  <li><strong>Tools</strong>: Unity 3D, MongoDB, Photoshop, etc.</li>
</ul>

<h3 id="video">Video</h3>

<iframe width="600" height="338" src="http://www.youtube.com/embed/wPkRVZj8reQ" frameborder="0" allowfullscreen=""></iframe>

<h3 id="challenges">Challenges</h3>

<h4 id="graphic-performance">Graphic Performance</h4>

<ul>
  <li>
    <p><strong>Problem 1: Unable to reach 60 fps on target platform.</strong> One of the most important goal of this game is to run smoothly and fast on mobile devices. All 3D games I have been involved was slow, so I gave myself this challenge.</p>
  </li>
  <li>
    <p><strong>Problem 2: Characters are not easily recognizable.</strong> I use realistic character model at first. But the camera perspective made it hard to see all details on the model, and on the other hand, these details reduced game application speed.</p>
  </li>
  <li>
    <p><strong>Solution: Change character models and game object resources.</strong> Actually, I change the art style of the entire game.</p>
  </li>
</ul>

<div style="width:100%;"><div style="margin-left:50px;">
	Old character and level objects
	<div style="width:100%;"><div style="margin-left:15px;">
		<img src="/img/spacemusketeer/v2lobby.jpg" align="middle" style="margin:5px 3px" width="400" />
		<img src="/img/spacemusketeer/v2scene.jpg" align="middle" style="margin:5px 3px" width="400" />
	</div></div>
	New character and level objects
	<div style="width:100%;"><div style="margin-left:15px;">
		<img src="/img/spacemusketeer/v3lobby.jpg" align="middle" style="margin:5px 3px" width="400" />
		<img src="/img/spacemusketeer/v3scene.jpg" align="middle" style="margin:5px 3px" width="400" />
	</div></div>
</div></div>

<ul>
  <li><strong>Result: The fps increased from 30 to 80. Characters became easily recognizable.</strong></li>
</ul>
<div style="width:100%;"><div style="margin-left:50px;">
	Old version performance
	<div style="width:100%;"><div style="margin-left:15px;">
		<img src="/img/spacemusketeer/v2performance.jpg" align="middle" style="margin:5px 3px" />
	</div></div>
	New version performance
	<div style="width:100%;"><div style="margin-left:15px;">
		<img src="/img/spacemusketeer/v3performance.jpg" align="middle" style="margin:5px 3px" />
	</div></div>
</div></div>

<h4 id="network">Network</h4>

<ul>
  <li>
    <p><strong>Problem: I used UNet as network solution, but it doesn’t support multi-room.</strong> UNet is a high level abstraction framework provided by Unity. It can solve complex problems with simple code. But each server could only have 1 battle field. It was difficult to build a game lobby with more than one rooms.</p>
  </li>
  <li>
    <p><strong>Solution: I built a new network toplogy model.</strong> It has three types of nodes, Master Server Node, Slave Server Node and Client Node. Master server runs first, and slave server and client connect to it. When a client request to start a battle, the master server assign a slave server to set up the battle field, then tell the client to connect to it.</p>
  </li>
</ul>

<div style="width:100%;"><div style="margin-left:50px;">
	<div style="width:100%;"><div style="margin-left:15px;">
		<img src="/img/spacemusketeer/networkinit.jpg" align="middle" style="margin:5px 3px" width="400" />
		<img src="/img/spacemusketeer/networkconnect.jpg" align="middle" style="margin:5px 3px" width="400" />
	</div></div>
</div></div>

<ul>
  <li><strong>Result: It works well. It can also solve network latency problem.</strong> This solution seperate rooms and lobby, so we can put slave servers all over the world. Then the network latency problem will be easily solved.</li>
</ul>

<h4 id="animation">Animation</h4>

<ul>
  <li>
    <p><strong>Problem: Prepare animation resources for game program to control.</strong> I bought all animations from Asset Store, and the animations were not yet binded with the character model skeletons.</p>
  </li>
  <li>
    <p><strong>Solution: Use Animator Manager to blend animations and build state machine.</strong></p>
  </li>
</ul>

<div style="width:100%;"><div style="margin-left:50px;">
	Seperate the skeletons to upper body and lower body
	<div style="width:100%;"><div style="margin-left:15px;">
		<img src="/img/spacemusketeer/upperbody.jpg" align="middle" style="margin:5px 3px" width="200" />
	</div></div>
	Build animation state machines for both upper body and lower body
	<div style="width:100%;"><div style="margin-left:15px;">
		<img src="/img/spacemusketeer/animfsmhand.jpg" align="middle" style="margin:5px 3px" width="400" />
		<img src="/img/spacemusketeer/animfsmfoot.jpg" align="middle" style="margin:5px 3px" width="400" />
	</div></div>
	Build animation blend tree for the aiming-walking state
	<div style="width:100%;"><div style="margin-left:15px;">
		<img src="/img/spacemusketeer/animfsmblendtree.jpg" align="middle" style="margin:5px 3px" width="400" />
	</div></div>
</div></div>

<ul>
  <li><strong>Result: The character model was able to walk fluent when shooting to all directions.</strong></li>
</ul>

<div style="width:100%;"><div style="margin-left:50px;">
	<div style="width:100%;"><div style="margin-left:15px;">
		<iframe width="240" height="200" src="http://www.youtube.com/embed/9PYjoBFz-kE" frameborder="0" allowfullscreen=""></iframe>
	</div></div>
</div></div>

<h4 id="lighting">Lighting</h4>

<ul>
  <li>
    <p><strong>Problem: Need lighting and shadow effect for static object and character.</strong> I couldn’t use real-time lighting because it has very high performance impact.</p>
  </li>
  <li>
    <p><strong>Solution: Baked GI for static object, light probe and shadow shader for character.</strong> I add a pass in the character model shader. And this pass could draw a shadow of the character. The character model shadow shader code:</p>
  </li>
</ul>

<div style="width:100%;">
<div style="margin-left:50px;">

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">Tags</span> <span class="p">{</span> <span class="s">"Queue"</span> <span class="o">=</span> <span class="s">"Transparent"</span> <span class="p">}</span>

<span class="n">Pass</span> <span class="p">{</span>
    <span class="c1">// use stencil to prevent overdraw, overdraw of transparent object is unacceptable
</span>    <span class="n">Stencil</span> <span class="p">{</span>
        <span class="n">Ref</span> <span class="mi">1</span>
        <span class="n">Comp</span> <span class="n">notequal</span>
        <span class="n">Pass</span> <span class="n">replace</span>
    <span class="p">}</span>

    <span class="n">Blend</span> <span class="n">SrcAlpha</span> <span class="n">OneMinusSrcAlpha</span>

    <span class="n">CGPROGRAM</span>
        <span class="cp">#pragma vertex vert
</span>        <span class="cp">#pragma fragment frag
</span>
        <span class="c1">// project the model to the plane which y=2.501 
</span>        <span class="n">float4</span> <span class="n">vert</span><span class="p">(</span><span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">)</span> <span class="o">:</span> <span class="n">SV_POSITION</span> <span class="p">{</span>
            <span class="n">float4</span> <span class="n">m1</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">_Object2World</span><span class="p">,</span> <span class="n">vertex</span><span class="p">);</span>
            <span class="kt">float</span> <span class="n">h</span> <span class="o">=</span> <span class="n">m1</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="mf">2.501</span><span class="p">;</span>
            <span class="n">m1</span><span class="p">.</span><span class="n">x</span> <span class="o">-=</span> <span class="n">h</span> <span class="o">*</span> <span class="mf">0.32</span><span class="p">;</span>
            <span class="n">m1</span><span class="p">.</span><span class="n">z</span> <span class="o">-=</span> <span class="n">h</span> <span class="o">*</span> <span class="mf">0.24</span><span class="p">;</span>
            <span class="n">m1</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">2.501</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_VP</span><span class="p">,</span> <span class="n">m1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// draw the model with fixed color
</span>        <span class="n">fixed4</span> <span class="n">frag</span><span class="p">()</span> <span class="o">:</span> <span class="n">SV_Target</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">fixed4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.3</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="n">ENDCG</span>
<span class="p">}</span> </code></pre></figure>

</div>
</div>

<ul>
  <li><strong>Result: Greatly improve the graphic quality.</strong></li>
</ul>

<div style="width:100%;"><div style="margin-left:50px;">
	Old static objects and static objects after Baked GI
	<div style="width:100%;"><div style="margin-left:15px;">
		<img src="/img/spacemusketeer/v3scene3.jpg" align="middle" style="margin:5px 3px" width="600" />
		<img src="/img/spacemusketeer/v3scene4.jpg" align="middle" style="margin:5px 3px" width="600" />
	</div></div>
	Character shadow
	<div style="width:100%;"><div style="margin-left:15px;">
		<img src="/img/spacemusketeer/noshadow.jpg" align="middle" style="margin:5px 3px" height="200" />
		<img src="/img/spacemusketeer/shadow.jpg" align="middle" style="margin:5px 3px" height="200" />
	</div></div>
</div></div>

<h4 id="physics">Physics</h4>

<ul>
  <li>
    <p><strong>Problem: The game behaviour when players walk toward a wall have to be predicable.</strong> I couldn’t use collision algorithm in PhysX engine because the movement speed of the characters is discrete. If I use an unpredicable phyiscs engine, the synchronization will be complex and not smooth.</p>
  </li>
  <li>
    <p><strong>Solution: Impelemented a 2D collide-and-slide algorithm.</strong> I didn’t built the physics algorithm from scratch. I use the collision detection in PhysX and wrote the reaction algorithm. I use 2D physics to reduce performance impact.</p>
  </li>
</ul>

<div style="width:100%;">
<div style="margin-left:50px;">

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="c1">// calculate movement after collide and slide 
</span><span class="n">Vector2</span> <span class="n">slideMovementVec</span> <span class="p">=</span> <span class="n">CordinateUtil</span><span class="p">.</span><span class="nf">calcMovementVec</span><span class="p">(</span><span class="n">slideSpdIdx</span><span class="p">,</span> <span class="n">slideDirIdx</span><span class="p">,</span> 
    <span class="n">Const</span><span class="p">.</span><span class="n">Movement</span><span class="p">.</span><span class="n">SPEED_IDX_NUM</span><span class="p">,</span> <span class="n">Const</span><span class="p">.</span><span class="n">Movement</span><span class="p">.</span><span class="n">DIRECTION_IDX_NUM</span><span class="p">,</span> 
    <span class="n">Time</span><span class="p">.</span><span class="n">deltaTime</span><span class="p">,</span> <span class="n">playerDataSync</span><span class="p">.</span><span class="n">MaxMovementSpeed</span><span class="p">);</span>

<span class="c1">// if player hits something after collide and slide
</span><span class="k">if</span> <span class="p">(</span><span class="n">playerProxy2D</span><span class="p">.</span><span class="nf">calcHitArray</span><span class="p">(</span><span class="n">slideMovementVec</span><span class="p">,</span> <span class="n">Const</span><span class="p">.</span><span class="n">Layer</span><span class="p">.</span><span class="n">WALK_OBSTACLE_MASK</span><span class="p">).</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// set speed to 0
</span>    <span class="c1">// ...
</span><span class="p">}</span>
<span class="k">else</span> <span class="p">{</span> 
    <span class="c1">// move the player
</span>    <span class="n">playerProxy2D</span><span class="p">.</span><span class="nf">Move</span><span class="p">(</span><span class="n">slideMovementVec</span><span class="p">);</span>
    <span class="c1">// ...
</span><span class="p">}</span></code></pre></figure>

</div>
</div>

<ul>
  <li><strong>Result: Accurate synchronization, high-performance, safety.</strong> 2D physics ensure high-performance. And all movement logic is calculated in server, which ensure security.</li>
</ul>


    </div>
</div>

<hr>



	<!-- Footer -->

	<footer>
	    <div class="row">
		<div class="col-lg-12">
		    <p>Copyright &copy; Wang Yang , 2016</p>
		</div>
	    </div>
	    <!-- /.row -->
	</footer>

    </div>
    <!-- /.container -->

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

</body>

</html>
